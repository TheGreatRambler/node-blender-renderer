<!DOCTYPE html>
<html>

<head>
    <title>Blender Renderer</title>
</head>

<body>
    <form id="fileform" action="/blenderfile" enctype="multipart/form-data" method="post">
        <label for="blend-file"> Enter Blend file here:</label>
        <input id="blend-file" type="file" name="blenderfile" accept=".blend">
        <input type="submit" value="Submit">
    </form>
    <table id="output">
        <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
        <script>
            $("#fileform").submit(function(e) {
                console.log("file recieved");
                $.ajax({
                    method: "POST",
                    cache: false,
                    contentType: false,
                    processData: false,
                    url: "/blenderfile",
                    data: new FormData($(this)[0])
                }).done(start);
                return false;
            });

            function parse_query_string(query) {
                var vars = query.split("&");
                var query_string = {};
                for (var i = 0; i < vars.length; i++) {
                    var pair = vars[i].split("=");
                    var key = decodeURIComponent(pair[0]);
                    var value = decodeURIComponent(pair[1]);
                    // If first entry with this name
                    if (typeof query_string[key] === "undefined") {
                        query_string[key] = decodeURIComponent(value);
                        // If second entry with this name
                    } else if (typeof query_string[key] === "string") {
                        var arr = [query_string[key], decodeURIComponent(value)];
                        query_string[key] = arr;
                        // If third or later entry with this name
                    } else {
                        query_string[key].push(decodeURIComponent(value));
                    }
                }
                return query_string;
            }

            function start() {
                var socket = new WebSocket("ws://" + parse_query_string(window.location.search.substring(1)).ip);
                var output = document.getElementById("output");
                socket.onopen = function() {
                    socket.send("");
                };
                socket.onmessage = function(message) {
                    var recieveddata = JSON.parse(message.data);
                    if (recieveddata.target === "processingoutput") {
                        var columns = recieveddata.data.split("|");
                        var row = output.insertRow(0);
                        columns.forEach(function(item, index) {
                            row.insertCell(index).innerHTML = item;
                        });
                        if (output.rows.length > 100) {
                            output.deleteRow(-1);
                        }
                    }
                };
            }
        </script>
</body>

</html>
